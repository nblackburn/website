---
import config from '@app/config';
import { Image } from 'astro:assets';
import Link from '@components/link.vue';
import PageLayout from '@layouts/page.astro';
import { GetStaticPaths, Page } from 'astro';
import { getCollection } from 'astro:content';
import Pagination from '@components/pagination.vue';
import ProjectCard from '@components/projectCard.vue';
import ProjectList from '@components/projectList.vue';
import slugify from '@root/src/utilities/slugify';

interface Props {
    page: Page;
}

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
    const uniqueTags: string[] = [];
    const projects = await getCollection('project');

    projects.forEach((project) => {
        const data = project.data;

        data.tags.forEach((tag) => {
            if (!uniqueTags.includes(tag)) {
                uniqueTags.push(tag);
            }
        });
    });

    return uniqueTags.map((tag) => {
        const slug = slugify(tag);
        const mappedItems = projects
            .filter((project) => {
                const data = project.data;
                const slugs = data.tags.map((tag) => slugify(tag));

                return slugs.includes(slug);
            })
            .map((project) => {
                return {
                    props: project,
                    params: { tag: slug }
                };
            });

        return paginate(mappedItems, {
            props: { tag: slug },
            params: { tag: slug },
            pageSize: config.pagination.limit
        });
    });
};

const title = 'Projects';
const activePage = 'projects';
const { page, tag } = Astro.props;
const subTitle = 'Some of the things i have worked on';
---

<PageLayout title={title} subTitle={subTitle} activePage={activePage}>
    <ProjectList>
        {
            page.data.map(({ props }) => (
                <ProjectCard project={props} activeTag={tag}>
                    <Link href={props.data.url} slot="thumbnail">
                        <Image
                            src={props.data.thumbnail}
                            alt={props.data.title}
                            width={768}
                            height={200}
                            loading="eager"
                            format="webp"
                        />
                    </Link>
                </ProjectCard>
            ))
        }
    </ProjectList>
    <Pagination links={page.url} />
</PageLayout>
